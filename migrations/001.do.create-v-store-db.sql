BEGIN;

DROP TABLE IF EXISTS reviews;
DROP TABLE IF EXISTS buyer;
DROP TABLE IF EXISTS seller_products;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS seller;
DROP TABLE IF EXISTS users;
DROP TYPE IF EXISTS service_type_enum;
DROP TYPE IF EXISTS user_type_enum;

CREATE TYPE user_type_enum AS ENUM(
    'seller',
    'buyer'
);

CREATE TABLE users(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    avatar_url TEXT DEFAULT 'default' NOT NULL,
    user_type user_type_enum NOT NULL
);

CREATE TYPE service_type_enum AS ENUM(
    'food and drinks',
    'clothing and accessories',
    'tattoo service',
    'fortune telling',
    'body healing',
    'educational',
    ''
);

CREATE TABLE seller(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    login_id INTEGER REFERENCES users(id) NOT NULL UNIQUE,
    shop_name TEXT NOT NULL,
    address TEXT NOT NULL,
    start_date DATE DEFAULT NOW(),
    end_date DATE DEFAULT NOW(),
    opening_time TIME DEFAULT '00:00:00',
    closing_time TIME DEFAULT '00:00:00',
    service_type service_type_enum NOT NULL 
);

CREATE TABLE products(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    item TEXT NOT NULL,
    price NUMERIC(9,2) DEFAULT 0.0,
    image_url TEXT DEFAULT 'no_url' NOT NULL
);

CREATE TABLE seller_products(
    seller_id INTEGER REFERENCES seller(id) NOT NULL,
    product_id INTEGER REFERENCES products(id) NOT NULL,
    PRIMARY KEY (seller_id, product_id)
);

CREATE TABLE buyer(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    login_id INTEGER REFERENCES users(id) NOT NULL UNIQUE,
    name TEXT NOT NULL
);

CREATE TABLE reviews(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    review TEXT NOT NULL,
    rating NUMERIC(3,2) NOT NUll,
    seller_id INTEGER REFERENCES seller(id) NOT NULL,
    buyer_id INTEGER REFERENCES buyer(id) NOT NULL
);

INSERT INTO users (username, password, user_type) VALUES 
    ('dummyuser001', 'password', 'seller'),
    ('dummyuser002', 'password', 'buyer');

INSERT INTO seller(login_id, shop_name, address, start_date, end_date, opening_time, closing_time, service_type) VALUES
    (1, 'Dummy Shop', '1234 ABC Street, New York, NY 11020', '2019-12-24', '2019-12-31',  '10:00:00', '22:00:00', 'food and drinks');


COMMIT;